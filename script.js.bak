/**
 * HAUS SIGNS - Quotation Calculator
 * Main Application Script
 */

// ==================== State ====================
const state = {
    prices: {},
    letters: [],
    logo: { name: '', type: 'frontLit', length: 0, width: 0, lengthInches: 0, widthInches: 0 },
    panel: { name: '', length: 0, width: 0, lengthInches: 0, widthInches: 0 },
    lightbox: { style: null, size: null, quantity: 1, customDimensions: null },
    anchor: {
        productType: 'letter',
        letter: { name: '', height: 0, heightInches: 0, charCount: 0 },
        logo: { name: '', length: 0, width: 0, lengthInches: 0, widthInches: 0 },
        panel: { name: '', length: 0, width: 0, lengthInches: 0, widthInches: 0 }
    },
    quotationItems: [],
    images: [],
    dp: 0
};

// ==================== Initialize ====================
function init() {
    // Load prices from settings
    state.prices = loadPrices();

    // Initialize settings form
    initSettingsForm(state.prices);

    // Setup settings listeners
    setupSettingsListeners(
        (newPrices) => {
            state.prices = newPrices;
            updateAllCalculations();
        },
        (defaultPrices) => {
            state.prices = defaultPrices;
            updateAllCalculations();
        }
    );

    // Apply custom lightbox formulas and render formula list
    applyCustomLightboxFormulas();
    renderLightboxFormulaList();
    setupLightboxFormulaListeners();

    // Set default date
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('quoteDate').value = today;

    // Add initial letter row
    addLetterRow();

    // Render lightbox styles
    renderLightboxStyles();

    // Setup event listeners
    setupTabListeners();
    setupSignageListeners();
    setupLightboxListeners();
    setupQuotationListeners();
    setupImageListeners();
    setupExportListeners();
    setupAnchorPricingListeners(); // Anchor pricing comparison
    setupSecretSettingsAccess(); // Hidden settings access

    // Initial render
    renderQuotationItems();
    updateSignageSummary();
}

// ==================== Secret Settings Access ====================
let logoClickCount = 0;
let logoClickTimer = null;

function setupSecretSettingsAccess() {
    const logoIcon = document.querySelector('.logo-icon');
    if (logoIcon) {
        logoIcon.style.cursor = 'pointer';
        logoIcon.addEventListener('click', handleSecretClick);
    }
}

function handleSecretClick() {
    logoClickCount++;

    // Reset counter after 3 seconds of no clicks
    if (logoClickTimer) clearTimeout(logoClickTimer);
    logoClickTimer = setTimeout(() => {
        logoClickCount = 0;
    }, 3000);

    // After 5 clicks, show settings tab
    if (logoClickCount >= 5) {
        const settingsBtn = document.getElementById('settingsTabBtn');
        if (settingsBtn) {
            settingsBtn.style.display = 'flex';
            settingsBtn.click();
            showNotification('Admin Settings unlocked!', 'success');
        }
        logoClickCount = 0;
    }
}

// ==================== Tab Navigation ====================
function setupTabListeners() {
    const tabBtns = document.querySelectorAll('.tab-btn');

    tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const tabId = btn.dataset.tab;

            // Update active tab button
            tabBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // Show corresponding content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabId}-tab`).classList.add('active');
        });
    });
}

// ==================== Signage Tab ====================
function setupSignageListeners() {
    // Add letter button
    document.getElementById('addLetterBtn').addEventListener('click', addLetterRow);

    // Logo name
    document.getElementById('logoName').addEventListener('input', (e) => {
        state.logo.name = e.target.value;
        updateSignageSummary();
    });

    // Logo type
    document.getElementById('logoType').addEventListener('input', updateLogoCalculation);

    // Logo inches inputs (auto-convert to cm)
    document.getElementById('logoLengthInches').addEventListener('input', (e) => {
        const inches = parseFloat(e.target.value) || 0;
        state.logo.lengthInches = inches;
        state.logo.length = Math.round(inches * INCH_TO_CM * 10) / 10;
        document.getElementById('logoLength').value = state.logo.length || '';
        updateLogoCalculation();
    });
    document.getElementById('logoWidthInches').addEventListener('input', (e) => {
        const inches = parseFloat(e.target.value) || 0;
        state.logo.widthInches = inches;
        state.logo.width = Math.round(inches * INCH_TO_CM * 10) / 10;
        document.getElementById('logoWidth').value = state.logo.width || '';
        updateLogoCalculation();
    });

    // Logo cm inputs (auto-convert to inches)
    document.getElementById('logoLength').addEventListener('input', (e) => {
        const cm = parseFloat(e.target.value) || 0;
        state.logo.length = cm;
        state.logo.lengthInches = Math.round(cm / INCH_TO_CM * 10) / 10;
        document.getElementById('logoLengthInches').value = state.logo.lengthInches || '';
        updateLogoCalculation();
    });
    document.getElementById('logoWidth').addEventListener('input', (e) => {
        const cm = parseFloat(e.target.value) || 0;
        state.logo.width = cm;
        state.logo.widthInches = Math.round(cm / INCH_TO_CM * 10) / 10;
        document.getElementById('logoWidthInches').value = state.logo.widthInches || '';
        updateLogoCalculation();
    });

    // Panel name
    document.getElementById('panelName').addEventListener('input', (e) => {
        state.panel.name = e.target.value;
        updateSignageSummary();
    });

    // Panel inches inputs (auto-convert to cm)
    document.getElementById('panelLengthInches').addEventListener('input', (e) => {
        const inches = parseFloat(e.target.value) || 0;
        state.panel.lengthInches = inches;
        state.panel.length = Math.round(inches * INCH_TO_CM * 10) / 10;
        document.getElementById('panelLength').value = state.panel.length || '';
        updatePanelCalculation();
    });
    document.getElementById('panelWidthInches').addEventListener('input', (e) => {
        const inches = parseFloat(e.target.value) || 0;
        state.panel.widthInches = inches;
        state.panel.width = Math.round(inches * INCH_TO_CM * 10) / 10;
        document.getElementById('panelWidth').value = state.panel.width || '';
        updatePanelCalculation();
    });

    // Panel cm inputs (auto-convert to inches)
    document.getElementById('panelLength').addEventListener('input', (e) => {
        const cm = parseFloat(e.target.value) || 0;
        state.panel.length = cm;
        state.panel.lengthInches = Math.round(cm / INCH_TO_CM * 10) / 10;
        document.getElementById('panelLengthInches').value = state.panel.lengthInches || '';
        updatePanelCalculation();
    });
    document.getElementById('panelWidth').addEventListener('input', (e) => {
        const cm = parseFloat(e.target.value) || 0;
        state.panel.width = cm;
        state.panel.widthInches = Math.round(cm / INCH_TO_CM * 10) / 10;
        document.getElementById('panelWidthInches').value = state.panel.widthInches || '';
        updatePanelCalculation();
    });

    // Add to quotation button
    document.getElementById('addToQuotationBtn').addEventListener('click', addSignageToQuotation);

    // Clear signage button
    document.getElementById('clearSignageBtn').addEventListener('click', clearSignage);
}

function addLetterRow() {
    const letterData = {
        id: Date.now(),
        name: '',
        type: 'frontLit',
        height: 0,
        heightInches: 0,
        charCount: 0
    };
    state.letters.push(letterData);
    renderLetterRows();
}

function removeLetterRow(id) {
    if (state.letters.length === 1) return;
    state.letters = state.letters.filter(l => l.id !== id);
    renderLetterRows();
    updateSignageSummary();
}

// Conversion constant: 1 inch = 2.54 cm
const INCH_TO_CM = 2.54;

function renderLetterRows() {
    const container = document.getElementById('letterRows');

    container.innerHTML = state.letters.map((letter, index) => `
    <div class="letter-row" data-id="${letter.id}">
      <div class="form-group letter-name-group">
        <label>Letter Content</label>
        <input type="text" class="letter-name" data-id="${letter.id}" 
               value="${letter.name || ''}" placeholder="E.g: HAUS SIGNS">
      </div>
      <div class="form-group">
        <label>Letter Type</label>
        <select class="letter-type" data-id="${letter.id}">
          ${LETTER_TYPES.map(t => `
            <option value="${t.id}" ${letter.type === t.id ? 'selected' : ''}>${t.name}</option>
          `).join('')}
        </select>
      </div>
      <div class="form-group">
        <label>Height (inches)</label>
        <input type="number" class="letter-height-inches" data-id="${letter.id}" 
               value="${letter.heightInches || ''}" placeholder="4" min="0" step="0.1">
      </div>
      <div class="form-group">
        <label>Height (cm)</label>
        <input type="number" class="letter-height" data-id="${letter.id}" 
               value="${letter.height || ''}" placeholder="10" min="0" step="0.1">
      </div>
      <div class="form-group">
        <label>Letter Count</label>
        <input type="number" class="letter-count" data-id="${letter.id}" 
               value="${letter.charCount || ''}" placeholder="0" min="0">
      </div>
      <div class="form-group result-display">
        <label>Price</label>
        <div class="result-value letter-price" data-id="${letter.id}">0 ‚Ç±</div>
      </div>
      <button class="remove-btn" data-id="${letter.id}" ${state.letters.length === 1 ? 'disabled' : ''}>‚úï</button>
    </div>
  `).join('');

    // Add event listeners for name
    container.querySelectorAll('.letter-name').forEach(input => {
        input.addEventListener('input', (e) => {
            const id = parseInt(e.target.dataset.id);
            const letter = state.letters.find(l => l.id === id);
            if (letter) {
                letter.name = e.target.value;
                updateSignageSummary();
            }
        });
    });

    container.querySelectorAll('.letter-type').forEach(select => {
        select.addEventListener('change', (e) => {
            const id = parseInt(e.target.dataset.id);
            const letter = state.letters.find(l => l.id === id);
            if (letter) {
                letter.type = e.target.value;
                updateLetterCalculation(id);
                updateSignageSummary();
            }
        });
    });

    // Inches input - auto convert to cm
    container.querySelectorAll('.letter-height-inches').forEach(input => {
        input.addEventListener('input', (e) => {
            const id = parseInt(e.target.dataset.id);
            const letter = state.letters.find(l => l.id === id);
            if (letter) {
                const inches = parseFloat(e.target.value) || 0;
                letter.heightInches = inches;
                letter.height = Math.round(inches * INCH_TO_CM * 10) / 10; // Round to 1 decimal
                // Update cm input
                const cmInput = container.querySelector(`.letter-height[data-id="${id}"]`);
                if (cmInput) cmInput.value = letter.height || '';
                updateLetterCalculation(id);
                updateSignageSummary();
            }
        });
    });

    // CM input - auto convert to inches
    container.querySelectorAll('.letter-height').forEach(input => {
        input.addEventListener('input', (e) => {
            const id = parseInt(e.target.dataset.id);
            const letter = state.letters.find(l => l.id === id);
            if (letter) {
                const cm = parseFloat(e.target.value) || 0;
                letter.height = cm;
                letter.heightInches = Math.round(cm / INCH_TO_CM * 10) / 10; // Round to 1 decimal
                // Update inches input
                const inchInput = container.querySelector(`.letter-height-inches[data-id="${id}"]`);
                if (inchInput) inchInput.value = letter.heightInches || '';
                updateLetterCalculation(id);
                updateSignageSummary();
            }
        });
    });

    container.querySelectorAll('.letter-count').forEach(input => {
        input.addEventListener('input', (e) => {
            const id = parseInt(e.target.dataset.id);
            const letter = state.letters.find(l => l.id === id);
            if (letter) {
                letter.charCount = parseInt(e.target.value) || 0;
                updateLetterCalculation(id);
                updateSignageSummary();
            }
        });
    });

    container.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const id = parseInt(e.target.dataset.id);
            removeLetterRow(id);
        });
    });
}

// Minimum letter height in cm
const MIN_LETTER_HEIGHT = 15;         // For Front Lit & All Lit letters
const MIN_LETTER_HEIGHT_BACKLIT = 10; // For Back Lit letters
const MIN_LETTER_HEIGHT_3D = 8;       // For 3D Non-LED letters

function getMinHeightForType(letterType) {
    if (letterType === '3d') return MIN_LETTER_HEIGHT_3D;
    if (letterType === 'backLit') return MIN_LETTER_HEIGHT_BACKLIT;
    return MIN_LETTER_HEIGHT;
}

function updateLetterCalculation(id) {
    const letter = state.letters.find(l => l.id === id);
    if (!letter) return;

    const priceEl = document.querySelector(`.letter-price[data-id="${id}"]`);
    if (!priceEl) return;

    // Validate minimum height based on letter type
    const minHeight = getMinHeightForType(letter.type);
    if (letter.height > 0 && letter.height < minHeight) {
        priceEl.textContent = `‚ö†Ô∏è Minimum ${minHeight}cm`;
        priceEl.style.color = 'var(--danger)';
        letter.isValid = false;
        updateSignageSummary();
        return;
    }

    letter.isValid = true;
    priceEl.style.color = '';

    const result = calculateLetterPrice(letter.height, letter.charCount, letter.type, state.prices);
    priceEl.textContent = `${formatNumber(result.price)} ‚Ç±`;
    updateSignageSummary();
}

function updateLogoCalculation() {
    state.logo.type = document.getElementById('logoType').value;

    const result = calculateLogoPrice(state.logo.length, state.logo.width, state.logo.type, state.prices);

    document.getElementById('logoResult').textContent = `${formatNumber(result.price)} ‚Ç±`;

    updateSignageSummary();
}

function updatePanelCalculation() {
    const result = calculatePanelPrice(state.panel.length, state.panel.width, state.prices);

    document.getElementById('panelResult').textContent = `${formatNumber(result.price)} ‚Ç±`;

    updateSignageSummary();
}

function updateSignageSummary() {
    const summary = document.getElementById('signageSummary');
    let totalPrice = 0;
    let rows = [];

    // Letters (skip invalid ones)
    state.letters.forEach((letter, index) => {
        const minHeight = getMinHeightForType(letter.type);
        if (letter.height >= minHeight && letter.charCount > 0 && letter.isValid !== false) {
            const result = calculateLetterPrice(letter.height, letter.charCount, letter.type, state.prices);
            const typeInfo = LETTER_TYPES.find(t => t.id === letter.type);
            const displayName = letter.name || `Raised Letters ${index + 1}`;
            rows.push({
                label: `${displayName}: ${typeInfo?.name || ''} (${letter.height}cm √ó ${letter.charCount} letters)`,
                value: result.price
            });
            totalPrice += result.price;
        }
    });

    // Logo
    if (state.logo.length > 0 && state.logo.width > 0) {
        const result = calculateLogoPrice(state.logo.length, state.logo.width, state.logo.type, state.prices);
        const typeInfo = LETTER_TYPES.find(t => t.id === state.logo.type);
        const displayName = state.logo.name || 'Logo';
        rows.push({
            label: `${displayName}: ${typeInfo?.name || ''} (${state.logo.length}√ó${state.logo.width}cm)`,
            value: result.price
        });
        totalPrice += result.price;
    }

    // Panel
    if (state.panel.length > 0 && state.panel.width > 0) {
        const result = calculatePanelPrice(state.panel.length, state.panel.width, state.prices);
        const displayName = state.panel.name || 'Alu Panel';
        rows.push({
            label: `${displayName} (${state.panel.length}√ó${state.panel.width}cm)`,
            value: result.price
        });
        totalPrice += result.price;
    }

    if (rows.length === 0) {
        summary.innerHTML = '<p style="color: var(--text-muted); text-align: center;">No products yet</p>';
        return;
    }

    summary.innerHTML = rows.map(row => `
    <div class="summary-row">
      <span class="label">${row.label}</span>
      <span class="value">${formatNumber(row.value)} ‚Ç±</span>
    </div>
  `).join('') + `
    <div class="summary-row total">
      <span class="label">Total</span>
      <span class="value">${formatNumber(totalPrice)} ‚Ç±</span>
    </div>
  `;
}

function addSignageToQuotation() {
    // Add letters (skip invalid ones)
    state.letters.forEach((letter, index) => {
        const minHeight = getMinHeightForType(letter.type);
        if (letter.height >= minHeight && letter.charCount > 0 && letter.isValid !== false) {
            const result = calculateLetterPrice(letter.height, letter.charCount, letter.type, state.prices);
            const typeInfo = LETTER_TYPES.find(t => t.id === letter.type);
            const displayName = letter.name || `Raised Letters`;
            state.quotationItems.push({
                description: `${displayName} - ${typeInfo?.name || ''} (${letter.height}cm x ${letter.charCount} letters)`,
                price: result.price
            });
        }
    });

    // Add logo
    if (state.logo.length > 0 && state.logo.width > 0) {
        const result = calculateLogoPrice(state.logo.length, state.logo.width, state.logo.type, state.prices);
        const typeInfo = LETTER_TYPES.find(t => t.id === state.logo.type);
        const displayName = state.logo.name || 'Logo';
        state.quotationItems.push({
            description: `${displayName} - ${typeInfo?.name || ''} (${state.logo.length}√ó${state.logo.width}cm)`,
            price: result.price
        });
    }

    // Add panel
    if (state.panel.length > 0 && state.panel.width > 0) {
        const result = calculatePanelPrice(state.panel.length, state.panel.width, state.prices);
        const displayName = state.panel.name || 'Alu Panel';
        state.quotationItems.push({
            description: `${displayName} (${state.panel.length}√ó${state.panel.width}cm)`,
            price: result.price
        });
    }

    renderQuotationItems();
    clearSignage();

    // Switch to quotation tab
    document.querySelector('[data-tab="quotation"]').click();

    showNotification('Added to quotation!', 'success');
}

function clearSignage() {
    state.letters = [];
    addLetterRow();

    state.logo = { name: '', type: 'frontLit', length: 0, width: 0, lengthInches: 0, widthInches: 0 };
    document.getElementById('logoName').value = '';
    document.getElementById('logoType').value = 'frontLit';
    document.getElementById('logoLengthInches').value = '';
    document.getElementById('logoLength').value = '';
    document.getElementById('logoWidthInches').value = '';
    document.getElementById('logoWidth').value = '';
    document.getElementById('logoResult').textContent = '0 ‚Ç±';

    state.panel = { name: '', length: 0, width: 0, lengthInches: 0, widthInches: 0 };
    document.getElementById('panelName').value = '';
    document.getElementById('panelLengthInches').value = '';
    document.getElementById('panelLength').value = '';
    document.getElementById('panelWidthInches').value = '';
    document.getElementById('panelWidth').value = '';
    document.getElementById('panelResult').textContent = '0 ‚Ç±';

    updateSignageSummary();
}

// ==================== Lightbox Tab ====================
function setupLightboxListeners() {
    // Quantity input
    document.getElementById('lightboxQty').addEventListener('input', updateLightboxCalculation);

    // Custom size inputs - Inches (auto-convert to cm)
    document.getElementById('customWidthInches').addEventListener('input', (e) => {
        const inches = parseFloat(e.target.value) || 0;
        const cm = Math.round(inches * INCH_TO_CM * 10) / 10;
        document.getElementById('customWidth').value = cm || '';
        updateLightboxCalculation();
    });
    document.getElementById('customHeightInches').addEventListener('input', (e) => {
        const inches = parseFloat(e.target.value) || 0;
        const cm = Math.round(inches * INCH_TO_CM * 10) / 10;
        document.getElementById('customHeight').value = cm || '';
        updateLightboxCalculation();
    });
    document.getElementById('customDepthInches').addEventListener('input', (e) => {
        const inches = parseFloat(e.target.value) || 0;
        const cm = Math.round(inches * INCH_TO_CM * 10) / 10;
        document.getElementById('customDepth').value = cm || '';
        updateLightboxCalculation();
    });

    // Custom size inputs - CM (auto-convert to inches)
    document.getElementById('customWidth').addEventListener('input', (e) => {
        const cm = parseFloat(e.target.value) || 0;
        const inches = Math.round(cm / INCH_TO_CM * 10) / 10;
        document.getElementById('customWidthInches').value = inches || '';
        updateLightboxCalculation();
    });
    document.getElementById('customHeight').addEventListener('input', (e) => {
        const cm = parseFloat(e.target.value) || 0;
        const inches = Math.round(cm / INCH_TO_CM * 10) / 10;
        document.getElementById('customHeightInches').value = inches || '';
        updateLightboxCalculation();
    });
    document.getElementById('customDepth').addEventListener('input', (e) => {
        const cm = parseFloat(e.target.value) || 0;
        const inches = Math.round(cm / INCH_TO_CM * 10) / 10;
        document.getElementById('customDepthInches').value = inches || '';
        updateLightboxCalculation();
    });

    // Add to quotation
    document.getElementById('addLightboxToQuotationBtn').addEventListener('click', addLightboxToQuotation);
}

function renderLightboxStyles() {
    const container = document.getElementById('lightboxStyles');

    container.innerHTML = Object.entries(LIGHTBOX_STYLES).map(([id, style]) => `
    <div class="lightbox-style-card" data-style="${id}">
      <div class="style-number">${id}</div>
      <div class="style-name">${style.name.replace(`Style ${id} - `, '')}</div>
    </div>
  `).join('');

    // Add click listeners
    container.querySelectorAll('.lightbox-style-card').forEach(card => {
        card.addEventListener('click', () => selectLightboxStyle(parseInt(card.dataset.style)));
    });
}

function selectLightboxStyle(styleId) {
    const style = LIGHTBOX_STYLES[styleId];
    if (!style) return;

    state.lightbox.style = styleId;
    state.lightbox.size = null;
    state.lightbox.customDimensions = null;

    // Update UI
    document.querySelectorAll('.lightbox-style-card').forEach(card => {
        card.classList.toggle('selected', parseInt(card.dataset.style) === styleId);
    });

    // Show config panel
    document.getElementById('lightboxConfig').style.display = 'block';
    document.getElementById('selectedStyleName').textContent = style.name;

    // Render size buttons
    renderSizeButtons(styleId);
}

function renderSizeButtons(styleId) {
    const style = LIGHTBOX_STYLES[styleId];
    const container = document.getElementById('sizeButtons');

    container.innerHTML = Object.entries(style.sizes).map(([size, data]) => `
    <button class="size-btn" data-size="${size}">
      <span class="size-label">${size}</span>
      <span class="size-dimensions">${data.label.replace(`${size}: `, '')}</span>
    </button>
  `).join('') + `
    <button class="size-btn" data-size="custom">
      <span class="size-label">Custom</span>
      <span class="size-dimensions">Custom size</span>
    </button>
  `;

    container.querySelectorAll('.size-btn').forEach(btn => {
        btn.addEventListener('click', () => selectLightboxSize(btn.dataset.size));
    });
}

function selectLightboxSize(size) {
    state.lightbox.size = size;

    // Update UI
    document.querySelectorAll('.size-btn').forEach(btn => {
        btn.classList.toggle('selected', btn.dataset.size === size);
    });

    // Show/hide custom inputs
    const customInputs = document.getElementById('customSizeInputs');
    if (size === 'custom') {
        customInputs.style.display = 'block';
        state.lightbox.customDimensions = {
            width: parseFloat(document.getElementById('customWidth').value) || 0,
            height: parseFloat(document.getElementById('customHeight').value) || 0,
            depth: parseFloat(document.getElementById('customDepth').value) || 0
        };
    } else {
        customInputs.style.display = 'none';
        state.lightbox.customDimensions = null;
    }

    updateLightboxCalculation();
}

function updateLightboxCalculation() {
    // Clear any previous warning
    const warningEl = document.getElementById('lightboxSizeWarning');
    if (warningEl) warningEl.style.display = 'none';
    state.lightbox.isValid = true;

    if (!state.lightbox.style || !state.lightbox.size) {
        document.getElementById('lightboxResult').textContent = '0 ‚Ç±';
        return;
    }

    const quantity = parseInt(document.getElementById('lightboxQty').value) || 1;
    state.lightbox.quantity = quantity;

    if (state.lightbox.size === 'custom') {
        state.lightbox.customDimensions = {
            width: parseFloat(document.getElementById('customWidth').value) || 0,
            height: parseFloat(document.getElementById('customHeight').value) || 0,
            depth: parseFloat(document.getElementById('customDepth').value) || 0
        };

        // Validate against Size S minimum
        const style = LIGHTBOX_STYLES[state.lightbox.style];
        if (style && style.sizes.S) {
            const sizeS = style.sizes.S;
            const custom = state.lightbox.customDimensions;

            if (custom.width > 0 && custom.height > 0 && custom.depth > 0) {
                if (custom.width < sizeS.width || custom.height < sizeS.height || custom.depth < sizeS.depth) {
                    state.lightbox.isValid = false;
                    if (warningEl) {
                        warningEl.textContent = `‚ö†Ô∏è Minimum size is Size S: ${sizeS.width}√ó${sizeS.height}√ó${sizeS.depth}cm`;
                        warningEl.style.display = 'block';
                    }
                    document.getElementById('lightboxResult').textContent = '‚ùå Invalid size';
                    document.getElementById('lightboxResult').style.color = 'var(--danger)';
                    return;
                }
            }
        }
    }

    document.getElementById('lightboxResult').style.color = '';

    const result = calculateLightboxPrice(
        state.lightbox.style,
        state.lightbox.size,
        quantity,
        state.lightbox.customDimensions,
        state.prices
    );

    document.getElementById('lightboxResult').textContent =
        `${formatNumber(result.totalPrice)} ‚Ç±`;
}

function addLightboxToQuotation() {
    if (!state.lightbox.style || !state.lightbox.size) {
        showNotification('Please select a lightbox style and size!', 'error');
        return;
    }

    // Block if custom size is too small
    if (state.lightbox.isValid === false) {
        showNotification('Lightbox size is too small! Please select a size larger than Size S.', 'error');
        return;
    }

    const style = LIGHTBOX_STYLES[state.lightbox.style];
    const quantity = state.lightbox.quantity;

    let sizeLabel = '';
    if (state.lightbox.size === 'custom') {
        const { width, height, depth } = state.lightbox.customDimensions;
        sizeLabel = `Custom (${width}√ó${height}√ó${depth}cm)`;
    } else {
        sizeLabel = style.sizes[state.lightbox.size].label;
    }

    const result = calculateLightboxPrice(
        state.lightbox.style,
        state.lightbox.size,
        quantity,
        state.lightbox.customDimensions,
        state.prices
    );

    state.quotationItems.push({
        description: `${style.name} - ${sizeLabel}`,
        price: result.totalPrice
    });

    renderQuotationItems();

    // Reset lightbox selection
    state.lightbox = { style: null, size: null, quantity: 1, customDimensions: null };
    document.querySelectorAll('.lightbox-style-card').forEach(card => card.classList.remove('selected'));
    document.getElementById('lightboxConfig').style.display = 'none';
    document.getElementById('lightboxQty').value = '1';
    document.getElementById('customWidthInches').value = '';
    document.getElementById('customWidth').value = '';
    document.getElementById('customHeightInches').value = '';
    document.getElementById('customHeight').value = '';
    document.getElementById('customDepthInches').value = '';
    document.getElementById('customDepth').value = '';
    document.getElementById('lightboxResult').textContent = '0 ‚Ç±';

    // Switch to quotation tab
    document.querySelector('[data-tab="quotation"]').click();

    showNotification('Lightbox added to quotation!', 'success');
}

// ==================== Quotation Tab ====================
function setupQuotationListeners() {
    document.getElementById('addItemBtn').addEventListener('click', addManualItem);
    document.getElementById('dpAmount').addEventListener('input', updateQuotationTotals);

    // Installation checkbox
    document.getElementById('installationCheck').addEventListener('change', (e) => {
        const priceSection = document.getElementById('installationPriceSection');
        priceSection.style.display = e.target.checked ? 'flex' : 'none';
        if (!e.target.checked) {
            document.getElementById('installationPrice').value = '0';
        }
        updateQuotationTotals();
    });

    document.getElementById('installationPrice').addEventListener('input', updateQuotationTotals);
}

function addManualItem() {
    state.quotationItems.push({
        description: '',
        price: 0
    });
    renderQuotationItems();
}

function removeQuotationItem(index) {
    state.quotationItems.splice(index, 1);
    renderQuotationItems();
}

function renderQuotationItems() {
    const tbody = document.getElementById('itemsBody');

    if (state.quotationItems.length === 0) {
        tbody.innerHTML = `
      <tr>
        <td colspan="3" style="text-align: center; color: var(--text-muted); padding: 2rem;">
          No products yet. Add from Signage or Lightbox tab.
        </td>
      </tr>
    `;
        updateQuotationTotals();
        return;
    }

    tbody.innerHTML = state.quotationItems.map((item, index) => `
    <tr>
      <td>
        <input type="text" placeholder="Product name" 
               value="${item.description}" 
               data-index="${index}" data-field="description">
      </td>
      <td>
        <input type="number" placeholder="0" min="0" step="0.01"
               value="${item.price || ''}" 
               data-index="${index}" data-field="price">
      </td>
      <td>
        <button class="remove-item-btn" data-index="${index}">‚úï</button>
      </td>
    </tr>
  `).join('');

    // Add event listeners
    tbody.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', handleItemInput);
    });

    tbody.querySelectorAll('.remove-item-btn').forEach(btn => {
        btn.addEventListener('click', () => removeQuotationItem(parseInt(btn.dataset.index)));
    });

    updateQuotationTotals();
}

function handleItemInput(e) {
    const index = parseInt(e.target.dataset.index);
    const field = e.target.dataset.field;
    let value = e.target.value;

    if (field === 'price') {
        value = parseFloat(value) || 0;
    }

    state.quotationItems[index][field] = value;
    updateQuotationTotals();
}

function updateQuotationTotals() {
    // Calculate items subtotal
    let subtotal = state.quotationItems.reduce((sum, item) => sum + (item.price || 0), 0);

    // Add installation if checked
    const installationChecked = document.getElementById('installationCheck').checked;
    const installationPrice = parseFloat(document.getElementById('installationPrice').value) || 0;

    if (installationChecked && installationPrice > 0) {
        subtotal += installationPrice;
    }

    state.dp = parseFloat(document.getElementById('dpAmount').value) || 0;
    const total = subtotal - state.dp;

    document.getElementById('subtotalDisplay').textContent = formatNumber(subtotal);
    document.getElementById('totalDisplay').textContent = formatNumber(total);
}

// ==================== Image Upload ====================
function setupImageListeners() {
    const uploadArea = document.getElementById('imageUploadArea');
    const input = document.getElementById('imageInput');

    uploadArea.addEventListener('click', () => input.click());
    input.addEventListener('change', handleImageSelect);

    uploadArea.addEventListener('dragover', handleDragOver);
    uploadArea.addEventListener('dragleave', handleDragLeave);
    uploadArea.addEventListener('drop', handleDrop);

    document.addEventListener('paste', handleGlobalPaste);
}

function handleImageSelect(e) {
    const files = Array.from(e.target.files);
    addImages(files);
}

function handleDragOver(e) {
    e.preventDefault();
    document.getElementById('imageUploadArea').classList.add('dragover');
}

function handleDragLeave(e) {
    e.preventDefault();
    document.getElementById('imageUploadArea').classList.remove('dragover');
}

function handleDrop(e) {
    e.preventDefault();
    document.getElementById('imageUploadArea').classList.remove('dragover');

    const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
    addImages(files);
}

function handleGlobalPaste(e) {
    const activeElement = document.activeElement;
    if (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA') {
        return;
    }

    const items = e.clipboardData?.items;
    if (!items) return;

    const imageFiles = [];
    for (const item of items) {
        if (item.type.startsWith('image/')) {
            const file = item.getAsFile();
            if (file) imageFiles.push(file);
        }
    }

    if (imageFiles.length > 0) {
        e.preventDefault();
        document.getElementById('imageUploadArea').classList.add('dragover');
        setTimeout(() => {
            document.getElementById('imageUploadArea').classList.remove('dragover');
        }, 300);
        addImages(imageFiles);
    }
}

function addImages(files) {
    files.forEach(file => {
        const reader = new FileReader();
        reader.onload = (e) => {
            state.images.push({
                name: file.name,
                data: e.target.result
            });
            renderImagePreviews();
        };
        reader.readAsDataURL(file);
    });
}

function renderImagePreviews() {
    const getLabel = (index) => index === 0 ? 'Layout' : `Additional ${index}`;

    document.getElementById('imagePreviews').innerHTML = state.images.map((img, index) => `
    <div class="image-preview-item">
      <img src="${img.data}" alt="${img.name}">
      <button class="remove-btn" data-index="${index}">‚úï</button>
      <div class="image-label">${getLabel(index)}</div>
    </div>
  `).join('');

    document.querySelectorAll('#imagePreviews .remove-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const index = parseInt(e.target.dataset.index);
            state.images.splice(index, 1);
            renderImagePreviews();
        });
    });
}

// ==================== Export ====================
function setupExportListeners() {
    document.getElementById('previewBtn').addEventListener('click', showPreview);
    document.getElementById('closePreview').addEventListener('click', hidePreview);
    document.getElementById('copyImageBtn').addEventListener('click', copyImageToClipboard);
    document.getElementById('exportPdfBtn').addEventListener('click', exportPDF);
    document.getElementById('exportImageBtn').addEventListener('click', exportImage);
}

function updatePDFTemplate() {
    // Customer info
    document.getElementById('pdfCustomerName').textContent = document.getElementById('customerName').value || '';
    document.getElementById('pdfAddress').textContent = document.getElementById('address').value || '';
    document.getElementById('pdfPhone').textContent = document.getElementById('phone').value || '';

    // Date
    const date = document.getElementById('quoteDate').value;
    const formattedDate = date ? new Date(date).toLocaleDateString('en-US', {
        month: '2-digit',
        day: '2-digit',
        year: 'numeric'
    }) : '';
    document.getElementById('pdfDate').textContent = formattedDate;

    // Items
    const itemsBody = document.getElementById('pdfItemsBody');
    itemsBody.innerHTML = '';

    let subtotal = 0;
    state.quotationItems.forEach(item => {
        if (item.description || item.price > 0) {
            subtotal += item.price || 0;

            const tr = document.createElement('tr');
            tr.innerHTML = `
        <td>${item.description}</td>
        <td></td>
        <td></td>
        <td>${formatNumber(item.price || 0)}</td>
      `;
            itemsBody.appendChild(tr);
        }
    });

    // Add installation if checked
    const installationChecked = document.getElementById('installationCheck').checked;
    const installationPrice = parseFloat(document.getElementById('installationPrice').value) || 0;

    if (installationChecked && installationPrice > 0) {
        subtotal += installationPrice;
        const tr = document.createElement('tr');
        tr.innerHTML = `
        <td>Installation Fee</td>
        <td></td>
        <td></td>
        <td>${formatNumber(installationPrice)}</td>
      `;
        itemsBody.appendChild(tr);
    }

    // Totals
    const dp = parseFloat(document.getElementById('dpAmount').value) || 0;
    const total = subtotal - dp;

    document.getElementById('pdfDP').textContent = formatNumber(dp);
    document.getElementById('pdfSubtotal').textContent = formatNumber(subtotal);
    document.getElementById('pdfTotal').textContent = formatNumber(total);

    // Update payment terms note based on installation
    const termsNote = document.querySelector('.pdf-template .terms-note');
    if (termsNote) {
        if (installationChecked && installationPrice > 0) {
            termsNote.innerHTML = '<strong>Note:</strong> Price includes accompanying accessories. This is a NON-VAT receipt.';
        } else {
            termsNote.innerHTML = '<strong>Note:</strong> Price includes accompanying accessories. Installation fees and shipping are not included. This is a NON-VAT receipt.';
        }
    }

    // Images
    const layoutContainer = document.getElementById('pdfLayoutImage');
    const imagesSection = document.getElementById('pdfImagesSection');

    if (layoutContainer) {
        if (state.images.length > 0) {
            layoutContainer.innerHTML = state.images.map((img, i) =>
                `<div class="pdf-image-row">
          <img src="${img.data}" alt="Layout ${i + 1}">
          <div class="pdf-image-label">Layout ${i + 1} of ${state.images.length}</div>
        </div>`
            ).join('');
            imagesSection.style.display = 'block';
        } else {
            layoutContainer.innerHTML = '';
            imagesSection.style.display = 'none';
        }
    }
}

function showPreview() {
    updatePDFTemplate();

    const template = document.getElementById('pdfTemplate');
    document.getElementById('previewContainer').innerHTML = template.innerHTML;

    document.getElementById('previewSection').classList.add('active');
    document.body.style.overflow = 'hidden';
}

function hidePreview() {
    document.getElementById('previewSection').classList.remove('active');
    document.body.style.overflow = '';
}

function exportPDF() {
    if (!document.getElementById('customerName').value.trim()) {
        showNotification('Please enter customer name!', 'error');
        document.getElementById('customerName').focus();
        return;
    }

    updatePDFTemplate();

    const template = document.getElementById('pdfTemplate');
    const pdfContent = template.querySelector('.pdf-content');
    const customerName = document.getElementById('customerName').value.replace(/[^a-zA-Z0-9]/g, '_');
    const date = new Date().toISOString().split('T')[0].replace(/-/g, '');
    const filename = `Quotation_${customerName}_${date}.pdf`;

    const btn = document.getElementById('exportPdfBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="icon">‚è≥</span> Generating...';

    template.style.position = 'static';
    template.style.left = 'auto';

    html2canvas(pdfContent, {
        scale: 2,
        useCORS: true,
        logging: false
    }).then(canvas => {
        const imgData = canvas.toDataURL('image/jpeg', 0.98);
        const imgWidth = 210;
        const pageHeight = (canvas.height * imgWidth) / canvas.width;

        const pdf = new jspdf.jsPDF({
            unit: 'mm',
            format: [imgWidth, pageHeight],
            orientation: 'portrait'
        });

        pdf.addImage(imgData, 'JPEG', 0, 0, imgWidth, pageHeight);
        pdf.save(filename);

        template.style.position = 'absolute';
        template.style.left = '-9999px';

        btn.disabled = false;
        btn.innerHTML = '<span class="icon">üìÑ</span> Export PDF';

        showNotification('PDF exported successfully!', 'success');
    }).catch(error => {
        console.error('Error generating PDF:', error);

        template.style.position = 'absolute';
        template.style.left = '-9999px';

        btn.disabled = false;
        btn.innerHTML = '<span class="icon">üìÑ</span> Export PDF';

        showNotification('Error generating PDF. Please try again!', 'error');
    });
}

function exportImage() {
    if (!document.getElementById('customerName').value.trim()) {
        showNotification('Please enter customer name!', 'error');
        document.getElementById('customerName').focus();
        return;
    }

    updatePDFTemplate();

    const template = document.getElementById('pdfTemplate');
    const pdfContent = template.querySelector('.pdf-content');
    const customerName = document.getElementById('customerName').value.replace(/[^a-zA-Z0-9]/g, '_');
    const date = new Date().toISOString().split('T')[0].replace(/-/g, '');
    const filename = `Quotation_${customerName}_${date}.png`;

    const btn = document.getElementById('exportImageBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="icon">‚è≥</span> Generating...';

    template.style.position = 'static';
    template.style.left = 'auto';

    html2canvas(pdfContent, {
        scale: 2,
        useCORS: true,
        logging: false
    }).then(canvas => {
        canvas.toBlob(blob => {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            template.style.position = 'absolute';
            template.style.left = '-9999px';

            btn.disabled = false;
            btn.innerHTML = '<span class="icon">üñºÔ∏è</span> Export Image';

            showNotification('Image exported successfully!', 'success');
        }, 'image/png');
    }).catch(error => {
        console.error('Error generating image:', error);

        template.style.position = 'absolute';
        template.style.left = '-9999px';

        btn.disabled = false;
        btn.innerHTML = '<span class="icon">üñºÔ∏è</span> Export Image';

        showNotification('Error generating image. Please try again!', 'error');
    });
}

function copyImageToClipboard() {
    if (!document.getElementById('customerName').value.trim()) {
        showNotification('Please enter customer name!', 'error');
        document.getElementById('customerName').focus();
        return;
    }

    updatePDFTemplate();

    const template = document.getElementById('pdfTemplate');
    const pdfContent = template.querySelector('.pdf-content');

    const btn = document.getElementById('copyImageBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="icon">‚è≥</span> Copying...';

    template.style.position = 'static';
    template.style.left = 'auto';

    html2canvas(pdfContent, {
        scale: 2,
        useCORS: true,
        logging: false
    }).then(canvas => {
        canvas.toBlob(async blob => {
            try {
                await navigator.clipboard.write([
                    new ClipboardItem({
                        'image/png': blob
                    })
                ]);

                template.style.position = 'absolute';
                template.style.left = '-9999px';

                btn.disabled = false;
                btn.innerHTML = '<span class="icon">üìã</span> Copy Image';

                showNotification('Image copied to clipboard!', 'success');
            } catch (err) {
                console.error('Failed to copy image:', err);

                template.style.position = 'absolute';
                template.style.left = '-9999px';

                btn.disabled = false;
                btn.innerHTML = '<span class="icon">üìã</span> Copy Image';

                showNotification('Failed to copy. Try Export Image instead.', 'error');
            }
        }, 'image/png');
    }).catch(error => {
        console.error('Error generating image:', error);

        template.style.position = 'absolute';
        template.style.left = '-9999px';

        btn.disabled = false;
        btn.innerHTML = '<span class="icon">üìã</span> Copy Image';

        showNotification('Error generating image. Please try again!', 'error');
    });
}

// ==================== Utilities ====================
function updateAllCalculations() {
    // Update all letter calculations
    state.letters.forEach(letter => {
        updateLetterCalculation(letter.id);
    });

    // Update logo and panel
    updateLogoCalculation();
    updatePanelCalculation();

    // Update lightbox
    updateLightboxCalculation();

    // Update summary
    updateSignageSummary();
}

// ==================== Anchor Pricing ====================
function setupAnchorPricingListeners() {
    // Generate quotation document button (only if it exists - removed old inputs)
    const generateBtn = document.getElementById('generateAnchorQuotation');
    if (generateBtn) {
        generateBtn.addEventListener('click', generateAnchorQuotationDocument);
    }

    const copyBtn = document.getElementById('copyAnchorQuotation');
    if (copyBtn) {
        copyBtn.addEventListener('click', copyAnchorQuotationToClipboard);
    }

    // "Add to Quotation" buttons (if they still exist)
    const addPremiumBtn = document.getElementById('addAnchorPremium');
    if (addPremiumBtn) {
        addPremiumBtn.addEventListener('click', () => addAnchorOption('premium'));
    }

    const addRecommendedBtn = document.getElementById('addAnchorRecommended');
    if (addRecommendedBtn) {
        addRecommendedBtn.addEventListener('click', () => addAnchorOption('recommended'));
    }

    const addBudgetBtn = document.getElementById('addAnchorBudget');
    if (addBudgetBtn) {
        addBudgetBtn.addEventListener('click', () => addAnchorOption('budget'));
    }

    const addAllBtn = document.getElementById('addAllAnchorOptions');
    if (addAllBtn) {
        addAllBtn.addEventListener('click', addAllAnchorOptions);
    }

    // Update anchor pricing when switching to the tab
    const anchorTab = document.querySelector('[data-tab="anchor"]');
    if (anchorTab) {
        anchorTab.addEventListener('click', () => {
            setTimeout(() => updateAnchorPricing(), 100);
        });
    }
}

function updateAnchorPricing() {
    const hasLetters = state.letters && state.letters.length > 0;
    const hasLogo = state.logo && state.logo.length > 0 && state.logo.width > 0;
    const hasPanel = state.panel && state.panel.length > 0 && state.panel.width > 0;

    if (!hasLetters && !hasLogo && !hasPanel) {
        // Show empty state
        document.getElementById('anchorProductList').innerHTML = `
            <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                <div style="font-size: 3.5rem; margin-bottom: 1rem;">üì¶</div>
                <div style="font-size: 1.1rem; font-weight: 500;">No products configured yet</div>
                <div style="font-size: 0.9rem; margin-top: 0.5rem; opacity: 0.8;">Add letters, logo, or panel in the Signage tab first</div>
            </div>
        `;
        document.getElementById('anchorComparisonCard').style.display = 'none';
        return;
    }

    // Build product list HTML
    let productListHTML = '<div style="display: flex; flex-direction: column; gap: 1rem;">';

    // Add letters
    if (hasLetters) {
        state.letters.forEach((letter, index) => {
            const typeName = LETTER_TYPES.find(t => t.id === letter.type)?.name || letter.type;
            productListHTML += `
                <div style="background: var(--bg-input); padding: 1rem; border-radius: 8px; border-left: 3px solid var(--primary);">
                    <div style="font-weight: 600; margin-bottom: 0.5rem;">‚úçÔ∏è ${letter.name || `Letters #${index + 1}`}</div>
                    <div style="font-size: 0.9rem; color: var(--text-secondary); line-height: 1.6;">
                        <div><strong>Type:</strong> ${typeName}</div>
                        <div><strong>Height:</strong> ${letter.height} cm</div>
                        <div><strong>Count:</strong> ${letter.charCount} letters</div>
                    </div>
                </div>
            `;
        });
    }

    // Add logo
    if (hasLogo) {
        const typeName = LETTER_TYPES.find(t => t.id === state.logo.type)?.name || state.logo.type;
        productListHTML += `
            <div style="background: var(--bg-input); padding: 1rem; border-radius: 8px; border-left: 3px solid var(--primary);">
                <div style="font-weight: 600; margin-bottom: 0.5rem;">üé® ${state.logo.name || 'Logo'}</div>
                <div style="font-size: 0.9rem; color: var(--text-secondary); line-height: 1.6;">
                    <div><strong>Type:</strong> ${typeName}</div>
                    <div><strong>Dimensions:</strong> ${state.logo.length} cm √ó ${state.logo.width} cm</div>
                    <div><strong>Area:</strong> ${((state.logo.length * state.logo.width) / 10000).toFixed(2)} m¬≤</div>
                </div>
            </div>
        `;
    }

    // Add panel
    if (hasPanel) {
        productListHTML += `
            <div style="background: var(--bg-input); padding: 1rem; border-radius: 8px; border-left: 3px solid var(--primary);">
                <div style="font-weight: 600; margin-bottom: 0.5rem;">üìã ${state.panel.name || 'Background Panel'}</div>
                <div style="font-size: 0.9rem; color: var(--text-secondary); line-height: 1.6;">
                    <div><strong>Dimensions:</strong> ${state.panel.length} cm √ó ${state.panel.width} cm</div>
                    <div><strong>Area:</strong> ${((state.panel.length * state.panel.width) / 10000).toFixed(2)} m¬≤</div>
                </div>
            </div>
        `;
    }

    productListHTML += '</div>';
    document.getElementById('anchorProductList').innerHTML = productListHTML;

    // Calculate pricing for all products combined
    let premiumTotal = 0;
    let recommendedTotal = 0;
    let budgetTotal = 0;
    let productInfoHTML = '';

    // Calculate letters
    if (hasLetters) {
        state.letters.forEach((letter, index) => {
            // Premium = Inox price (2.5x multiplier applied via settings)
            const inoxResult = calculateLetterPrice(letter.height, letter.charCount, 'inox', state.prices);
            premiumTotal += inoxResult.price;

            // Recommended = Actual selected type
            const recommendedResult = calculateLetterPrice(letter.height, letter.charCount, letter.type, state.prices);
            recommendedTotal += recommendedResult.price;

            // Budget = 3D
            const budgetResult = calculateLetterPrice(letter.height, letter.charCount, '3d', state.prices);
            budgetTotal += budgetResult.price;

            const typeName = LETTER_TYPES.find(t => t.id === letter.type)?.name || letter.type;
            productInfoHTML += `
                <div style="margin-bottom: 0.5rem;">
                    <strong>${letter.name || `Letters #${index + 1}`}:</strong><br>
                    ${typeName} - ${letter.height}cm √ó ${letter.charCount} letters
                </div>
            `;
        });
    }

    // Calculate logo
    if (hasLogo) {
        const inoxResult = calculateLogoPrice(state.logo.length, state.logo.width, 'inox', state.prices);
        premiumTotal += inoxResult.price;

        const recommendedResult = calculateLogoPrice(state.logo.length, state.logo.width, state.logo.type, state.prices);
        recommendedTotal += recommendedResult.price;

        const budgetResult = calculateLogoPrice(state.logo.length, state.logo.width, '3d', state.prices);
        budgetTotal += budgetResult.price;

        const typeName = LETTER_TYPES.find(t => t.id === state.logo.type)?.name || state.logo.type;
        const area = ((state.logo.length * state.logo.width) / 10000).toFixed(2);
        productInfoHTML += `
            <div style="margin-bottom: 0.5rem;">
                <strong>${state.logo.name || 'Logo'}:</strong><br>
                ${typeName} - ${state.logo.length}cm √ó ${state.logo.width}cm (${area}m¬≤)
            </div>
        `;
    }

    // Calculate panel
    if (hasPanel) {
        const panelBasePrice = calculatePanelPrice(state.panel.length, state.panel.width, state.prices);

        // Premium = 2.5x panel price (simulating Inox)
        premiumTotal += panelBasePrice * state.prices.anchorMultiplier;

        // Recommended = Actual panel price
        recommendedTotal += panelBasePrice;

        // Budget = 0.7x panel price
        budgetTotal += panelBasePrice * 0.7;

        const area = ((state.panel.length * state.panel.width) / 10000).toFixed(2);
        productInfoHTML += `
            <div style="margin-bottom: 0.5rem;">
                <strong>${state.panel.name || 'Background Panel'}:</strong><br>
                Alu Panel - ${state.panel.length}cm √ó ${state.panel.width}cm (${area}m¬≤)
            </div>
        `;
    }

    // Update pricing display
    document.getElementById('anchorPricePremium').textContent = `${formatNumber(premiumTotal)} ‚Ç±`;
    document.getElementById('anchorPriceRecommended').textContent = `${formatNumber(recommendedTotal)} ‚Ç±`;
    document.getElementById('anchorPriceBudget').textContent = `${formatNumber(budgetTotal)} ‚Ç±`;

    const savings = premiumTotal - recommendedTotal;
    document.getElementById('anchorSavings').textContent = savings > 0 ? `Save ${formatNumber(savings)} ‚Ç± vs Inox!` : '';

    // Update product info in Best Value card
    const productInfoDiv = document.getElementById('anchorProductInfo');
    if (productInfoDiv) {
        productInfoDiv.innerHTML = `
            <div style="font-weight: 600; color: #16a34a; margin-bottom: 0.5rem;">üì¶ PRODUCT DETAILS:</div>
            ${productInfoHTML}
        `;
    }

    // Show comparison card
    document.getElementById('anchorComparisonCard').style.display = 'block';
}

function addAnchorOption(optionType) {
    const premiumPriceText = document.getElementById('anchorPricePremium').textContent;
    const recommendedPriceText = document.getElementById('anchorPriceRecommended').textContent;
    const budgetPriceText = document.getElementById('anchorPriceBudget').textContent;

    let description = '';
    let price = 0;
    let optionName = '';

    if (optionType === 'premium') {
        optionName = 'Premium Stainless Steel (Inox)';
        description = 'Stainless Steel (Inox) - Premium Option';
        price = parseFloat(premiumPriceText.replace(/[^\d.-]/g, ''));
    } else if (optionType === 'recommended') {
        optionName = 'Recommended Acrylic';
        description = 'Acrylic - Best Value ‚≠ê';
        price = parseFloat(recommendedPriceText.replace(/[^\d.-]/g, ''));
    } else if (optionType === 'budget') {
        optionName = 'Budget 3D';
        description = '3D Non-LED - Budget Option';
        price = parseFloat(budgetPriceText.replace(/[^\d.-]/g, ''));
    }

    if (price > 0) {
        state.quotationItems.push({ description, price });
        renderQuotationItems();

        // Switch to quotation tab
        document.querySelector('[data-tab="quotation"]').click();

        showNotification(`${optionName} added to quotation!`, 'success');
    }
}

function addAllAnchorOptions() {
    const premiumPriceText = document.getElementById('anchorPricePremium').textContent;
    const recommendedPriceText = document.getElementById('anchorPriceRecommended').textContent;
    const budgetPriceText = document.getElementById('anchorPriceBudget').textContent;

    const premiumPrice = parseFloat(premiumPriceText.replace(/[^\d.-]/g, ''));
    const recommendedPrice = parseFloat(recommendedPriceText.replace(/[^\d.-]/g, ''));
    const budgetPrice = parseFloat(budgetPriceText.replace(/[^\d.-]/g, ''));

    if (premiumPrice > 0) {
        state.quotationItems.push({ description: 'Option 1: Stainless Steel (Inox) - Premium', price: premiumPrice });
        state.quotationItems.push({ description: 'Option 2: Acrylic - Best Value ‚≠ê', price: recommendedPrice });
        state.quotationItems.push({ description: 'Option 3: 3D Non-LED - Budget', price: budgetPrice });

        renderQuotationItems();

        // Switch to quotation tab
        document.querySelector('[data-tab="quotation"]').click();

        showNotification('All 3 options added to quotation!', 'success');
    } else {
        showNotification('Please configure products in Signage tab first!', 'error');
    }
}

function generateAnchorQuotationDocument() {
    const hasProducts = (state.letters && state.letters.length > 0) ||
        (state.logo && state.logo.length > 0 && state.logo.width > 0) ||
        (state.panel && state.panel.length > 0 && state.panel.width > 0);

    if (!hasProducts) {
        showNotification('Please add products in the Signage tab first!', 'error');
        return;
    }

    // Update calculations
    updateAnchorPricing();

    // Build product specification
    let productSpec = '<div style="display: flex; flex-direction: column; gap: 0.75rem;">';

    if (state.letters && state.letters.length > 0) {
        state.letters.forEach((letter, index) => {
            const typeName = LETTER_TYPES.find(t => t.id === letter.type)?.name || letter.type;
            productSpec += `
                <div><strong>${index + 1}. ${letter.name || `Letters #${index + 1}`}:</strong> ${typeName} - ${letter.height}cm height √ó ${letter.charCount} letters</div>
            `;
        });
    }

    if (state.logo && state.logo.length > 0 && state.logo.width > 0) {
        const typeName = LETTER_TYPES.find(t => t.id === state.logo.type)?.name || state.logo.type;
        const area = ((state.logo.length * state.logo.width) / 10000).toFixed(2);
        productSpec += `
            <div><strong>Logo:</strong> ${state.logo.name || 'Logo'} - ${typeName} - ${state.logo.length}cm √ó ${state.logo.width}cm (${area}m¬≤)</div>
        `;
    }

    if (state.panel && state.panel.length > 0 && state.panel.width > 0) {
        const area = ((state.panel.length * state.panel.width) / 10000).toFixed(2);
        productSpec += `
            <div><strong>Panel:</strong> ${state.panel.name || 'Background Panel'} - ${state.panel.length}cm √ó ${state.panel.width}cm (${area}m¬≤)</div>
        `;
    }

    productSpec += '</div>';

    // Get calculated prices
    const premiumPriceText = document.getElementById('anchorPricePremium').textContent;
    const recommendedPriceText = document.getElementById('anchorPriceRecommended').textContent;
    const budgetPriceText = document.getElementById('anchorPriceBudget').textContent;
    const savingsText = document.getElementById('anchorSavings').textContent;

    // Update quotation document
    document.getElementById('anchorProductSpec').innerHTML = productSpec;
    document.getElementById('anchorDocPricePremium').textContent = premiumPriceText;
    document.getElementById('anchorDocPriceRecommended').textContent = recommendedPriceText;
    document.getElementById('anchorDocPriceBudget').textContent = budgetPriceText;
    document.getElementById('anchorDocSavings').textContent = savingsText || '';

    // Update date and quotation number
    const today = new Date();
    const dateStr = today.toLocaleDateString('en-US', { month: 'short', day: '2-digit', year: 'numeric' });
    const validUntil = new Date(today);
    validUntil.setDate(validUntil.getDate() + 30);
    const validUntilStr = validUntil.toLocaleDateString('en-US', { month: 'short', day: '2-digit', year: 'numeric' });

    const quoteNumber = `QT-${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}`;

    document.getElementById('anchorQuoteDate').textContent = dateStr;
    document.getElementById('anchorQuoteValidUntil').textContent = validUntilStr;
    document.getElementById('anchorQuoteNumber').textContent = quoteNumber;

    // Show quotation preview
    document.getElementById('anchorQuotationPreview').style.display = 'block';

    // Scroll to preview
    document.getElementById('anchorQuotationPreview').scrollIntoView({ behavior: 'smooth', block: 'start' });

    showNotification('Quotation document generated! You can now copy it to clipboard.', 'success');
}

function copyAnchorQuotationToClipboard() {
    const quotationDoc = document.getElementById('anchorQuotationDocument');

    if (!quotationDoc) {
        showNotification('No quotation to copy!', 'error');
        return;
    }

    // Create a range and selection
    const range = document.createRange();
    range.selectNode(quotationDoc);

    const selection = window.getSelection();
    selection.removeAllRanges();
    selection.addRange(range);

    try {
        // Try to copy HTML
        document.execCommand('copy');
        selection.removeAllRanges();
        showNotification('Quotation copied to clipboard! Paste it into your email or document.', 'success');
    } catch (err) {
        console.error('Copy failed:', err);
        showNotification('Copy failed. Please select and copy manually (Ctrl+C / Cmd+C).', 'error');
    }
}









state.anchor.letter.heightInches = inches;
state.anchor.letter.height = Math.round(inches * INCH_TO_CM * 10) / 10;
document.getElementById('anchorLetterHeight').value = state.anchor.letter.height || '';
updateAnchorCalculation();
});

document.getElementById('anchorLetterHeight').addEventListener('input', (e) => {
    const cm = parseFloat(e.target.value) || 0;
    state.anchor.letter.height = cm;
    state.anchor.letter.heightInches = Math.round(cm / INCH_TO_CM * 10) / 10;
    document.getElementById('anchorLetterHeightInches').value = state.anchor.letter.heightInches || '';
    updateAnchorCalculation();
});

document.getElementById('anchorLetterCount').addEventListener('input', (e) => {
    state.anchor.letter.charCount = parseInt(e.target.value) || 0;
    updateAnchorCalculation();
});

// Logo inputs
document.getElementById('anchorLogoName').addEventListener('input', (e) => {
    state.anchor.logo.name = e.target.value;
});

document.getElementById('anchorLogoLengthInches').addEventListener('input', (e) => {
    const inches = parseFloat(e.target.value) || 0;
    state.anchor.logo.lengthInches = inches;
    state.anchor.logo.length = Math.round(inches * INCH_TO_CM * 10) / 10;
    document.getElementById('anchorLogoLength').value = state.anchor.logo.length || '';
    updateAnchorCalculation();
});

document.getElementById('anchorLogoLength').addEventListener('input', (e) => {
    const cm = parseFloat(e.target.value) || 0;
    state.anchor.logo.length = cm;
    state.anchor.logo.lengthInches = Math.round(cm / INCH_TO_CM * 10) / 10;
    document.getElementById('anchorLogoLengthInches').value = state.anchor.logo.lengthInches || '';
    updateAnchorCalculation();
});

document.getElementById('anchorLogoWidthInches').addEventListener('input', (e) => {
    const inches = parseFloat(e.target.value) || 0;
    state.anchor.logo.widthInches = inches;
    state.anchor.logo.width = Math.round(inches * INCH_TO_CM * 10) / 10;
    document.getElementById('anchorLogoWidth').value = state.anchor.logo.width || '';
    updateAnchorCalculation();
});

document.getElementById('anchorLogoWidth').addEventListener('input', (e) => {
    const cm = parseFloat(e.target.value) || 0;
    state.anchor.logo.width = cm;
    state.anchor.logo.widthInches = Math.round(cm / INCH_TO_CM * 10) / 10;
    document.getElementById('anchorLogoWidthInches').value = state.anchor.logo.widthInches || '';
    updateAnchorCalculation();
});

// Panel inputs
document.getElementById('anchorPanelName').addEventListener('input', (e) => {
    state.anchor.panel.name = e.target.value;
});

document.getElementById('anchorPanelLengthInches').addEventListener('input', (e) => {
    const inches = parseFloat(e.target.value) || 0;
    state.anchor.panel.lengthInches = inches;
    state.anchor.panel.length = Math.round(inches * INCH_TO_CM * 10) / 10;
    document.getElementById('anchorPanelLength').value = state.anchor.panel.length || '';
    updateAnchorCalculation();
});

document.getElementById('anchorPanelLength').addEventListener('input', (e) => {
    const cm = parseFloat(e.target.value) || 0;
    state.anchor.panel.length = cm;
    state.anchor.panel.lengthInches = Math.round(cm / INCH_TO_CM * 10) / 10;
    document.getElementById('anchorPanelLengthInches').value = state.anchor.panel.lengthInches || '';
    updateAnchorCalculation();
});

document.getElementById('anchorPanelWidthInches').addEventListener('input', (e) => {
    const inches = parseFloat(e.target.value) || 0;
    state.anchor.panel.widthInches = inches;
    state.anchor.panel.width = Math.round(inches * INCH_TO_CM * 10) / 10;
    document.getElementById('anchorPanelWidth').value = state.anchor.panel.width || '';
    updateAnchorCalculation();
});

document.getElementById('anchorPanelWidth').addEventListener('input', (e) => {
    const cm = parseFloat(e.target.value) || 0;
    state.anchor.panel.width = cm;
    state.anchor.panel.widthInches = Math.round(cm / INCH_TO_CM * 10) / 10;
    document.getElementById('anchorPanelWidthInches').value = state.anchor.panel.widthInches || '';
    updateAnchorCalculation();
});

// Add to quotation buttons
document.getElementById('addAnchorPremium').addEventListener('click', () => addAnchorOption('premium'));
document.getElementById('addAnchorRecommended').addEventListener('click', () => addAnchorOption('recommended'));
document.getElementById('addAnchorBudget').addEventListener('click', () => addAnchorOption('budget'));
document.getElementById('addAllAnchorOptions').addEventListener('click', addAllAnchorOptions);
document.getElementById('clearAnchorBtn').addEventListener('click', clearAnchor);

// Quotation document buttons
document.getElementById('generateAnchorQuotation').addEventListener('click', generateAnchorQuotationDocument);
document.getElementById('copyAnchorQuotation').addEventListener('click', copyAnchorQuotationToClipboard);
}

function generateAnchorQuotationDocument() {
    const productType = state.anchor.productType;
    let isValid = false;
    let productSpec = '';

    // Validate and build product specification
    if (productType === 'letter') {
        const { name, height, charCount } = state.anchor.letter;
        if (height >= MIN_LETTER_HEIGHT && charCount > 0) {
            isValid = true;
            productSpec = `
                <div><strong>Product:</strong> Raised Letters</div>
                <div><strong>Content:</strong> ${name || 'Custom Letters'}</div>
                <div><strong>Height:</strong> ${height} cm (${state.anchor.letter.heightInches.toFixed(1)} inches)</div>
                <div><strong>Quantity:</strong> ${charCount} letters</div>
            `;
        }
    } else if (productType === 'logo') {
        const { name, length, width } = state.anchor.logo;
        if (length > 0 && width > 0) {
            isValid = true;
            productSpec = `
                <div><strong>Product:</strong> Raised Logo</div>
                <div><strong>Name:</strong> ${name || 'Custom Logo'}</div>
                <div><strong>Dimensions:</strong> ${length} cm √ó ${width} cm (${state.anchor.logo.lengthInches.toFixed(1)}" √ó ${state.anchor.logo.widthInches.toFixed(1)}")</div>
                <div><strong>Area:</strong> ${((length * width) / 10000).toFixed(2)} m¬≤</div>
            `;
        }
    } else if (productType === 'panel') {
        const { name, length, width } = state.anchor.panel;
        if (length > 0 && width > 0) {
            isValid = true;
            productSpec = `
                <div><strong>Product:</strong> Alu Background Panel</div>
                <div><strong>Name:</strong> ${name || 'Background Panel'}</div>
                <div><strong>Dimensions:</strong> ${length} cm √ó ${width} cm (${state.anchor.panel.lengthInches.toFixed(1)}" √ó ${state.anchor.panel.widthInches.toFixed(1)}")</div>
                <div><strong>Area:</strong> ${((length * width) / 10000).toFixed(2)} m¬≤</div>
            `;
        }
    }

    if (!isValid) {
        showNotification('Please enter valid product dimensions first!', 'error');
        return;
    }

    // Calculate prices (reuse existing calculation)
    updateAnchorCalculation();

    // Get calculated prices from the comparison cards
    const premiumPriceText = document.getElementById('anchorPricePremium').textContent;
    const recommendedPriceText = document.getElementById('anchorPriceRecommended').textContent;
    const budgetPriceText = document.getElementById('anchorPriceBudget').textContent;
    const savingsText = document.getElementById('anchorSavings').textContent;

    // Update quotation document
    document.getElementById('anchorProductSpec').innerHTML = productSpec;
    document.getElementById('anchorDocPricePremium').textContent = premiumPriceText;
    document.getElementById('anchorDocPriceRecommended').textContent = recommendedPriceText;
    document.getElementById('anchorDocPriceBudget').textContent = budgetPriceText;
    document.getElementById('anchorDocSavings').textContent = savingsText || '';

    // Update date and quotation number
    const today = new Date();
    const dateStr = today.toLocaleDateString('en-US', { month: 'short', day: '2-digit', year: 'numeric' });
    const validUntil = new Date(today);
    validUntil.setDate(validUntil.getDate() + 30);
    const validUntilStr = validUntil.toLocaleDateString('en-US', { month: 'short', day: '2-digit', year: 'numeric' });

    const quoteNumber = `QT-${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}`;

    document.getElementById('anchorQuoteDate').textContent = dateStr;
    document.getElementById('anchorQuoteValidUntil').textContent = validUntilStr;
    document.getElementById('anchorQuoteNumber').textContent = quoteNumber;

    // Show quotation preview
    document.getElementById('anchorQuotationPreview').style.display = 'block';

    // Scroll to preview
    document.getElementById('anchorQuotationPreview').scrollIntoView({ behavior: 'smooth', block: 'start' });

    showNotification('Quotation document generated! You can now copy it to clipboard.', 'success');
}

function copyAnchorQuotationToClipboard() {
    const quotationDoc = document.getElementById('anchorQuotationDocument');

    if (!quotationDoc) {
        showNotification('No quotation to copy!', 'error');
        return;
    }

    // Create a range and selection
    const range = document.createRange();
    range.selectNode(quotationDoc);

    const selection = window.getSelection();
    selection.removeAllRanges();
    selection.addRange(range);

    try {
        // Try to copy HTML
        document.execCommand('copy');
        selection.removeAllRanges();
        showNotification('Quotation copied to clipboard! Paste it into your email or document.', 'success');
    } catch (err) {
        console.error('Copy failed:', err);
        showNotification('Copy failed. Please select and copy manually (Ctrl+C / Cmd+C).', 'error');
    }
}

function showAnchorInputs(productType) {
    document.getElementById('anchorLetterInputs').style.display = productType === 'letter' ? 'block' : 'none';
    document.getElementById('anchorLogoInputs').style.display = productType === 'logo' ? 'block' : 'none';
    document.getElementById('anchorPanelInputs').style.display = productType === 'panel' ? 'block' : 'none';
}

function updateAnchorCalculation() {
    const productType = state.anchor.productType;
    let premiumPrice = 0, recommendedPrice = 0, budgetPrice = 0;

    if (productType === 'letter') {
        const { height, charCount } = state.anchor.letter;
        if (height >= MIN_LETTER_HEIGHT && charCount > 0) {
            const inoxResult = calculateLetterPrice(height, charCount, 'inox', state.prices);
            const acrylicResult = calculateLetterPrice(height, charCount, 'frontLit', state.prices);
            const budgetResult = calculateLetterPrice(height, charCount, '3d', state.prices);
            premiumPrice = inoxResult.price;
            recommendedPrice = acrylicResult.price;
            budgetPrice = budgetResult.price;
        }
    } else if (productType === 'logo') {
        const { length, width } = state.anchor.logo;
        if (length > 0 && width > 0) {
            const inoxResult = calculateLogoPrice(length, width, 'inox', state.prices);
            const acrylicResult = calculateLogoPrice(length, width, 'frontLit', state.prices);
            const budgetResult = calculateLogoPrice(length, width, '3d', state.prices);
            premiumPrice = inoxResult.price;
            recommendedPrice = acrylicResult.price;
            budgetPrice = budgetResult.price;
        }
    } else if (productType === 'panel') {
        const { length, width } = state.anchor.panel;
        if (length > 0 && width > 0) {
            const result = calculatePanelPrice(length, width, state.prices);
            premiumPrice = result.price * 2; // 2x for anchor
            recommendedPrice = result.price;
            budgetPrice = result.price * 0.7; // 70% for budget
        }
    }

    const savings = premiumPrice - recommendedPrice;

    // Update display
    document.getElementById('anchorPricePremium').textContent = `${formatNumber(premiumPrice)} ‚Ç±`;
    document.getElementById('anchorPriceRecommended').textContent = `${formatNumber(recommendedPrice)} ‚Ç±`;
    document.getElementById('anchorPriceBudget').textContent = `${formatNumber(budgetPrice)} ‚Ç±`;
    document.getElementById('anchorSavings').textContent = savings > 0 ? `Save ${formatNumber(savings)} ‚Ç± vs Inox!` : '';
}

function addAnchorOption(optionType) {
    const productType = state.anchor.productType;
    let description = '';
    let price = 0;
    let letterType = '';

    if (productType === 'letter') {
        const { name, height, charCount } = state.anchor.letter;
        if (height < MIN_LETTER_HEIGHT || charCount === 0) {
            showNotification('Please enter valid letter dimensions (min 15cm height) and count!', 'error');
            return;
        }

        if (optionType === 'premium') {
            letterType = 'inox';
            const typeInfo = LETTER_TYPES.find(t => t.id === 'inox');
            const result = calculateLetterPrice(height, charCount, 'inox', state.prices);
            price = result.price;
            description = `${name || 'Letters'} - ${typeInfo?.name || 'Inox'} (${height}cm x ${charCount} letters) - PREMIUM ANCHOR`;
        } else if (optionType === 'recommended') {
            letterType = 'frontLit';
            const typeInfo = LETTER_TYPES.find(t => t.id === 'frontLit');
            const result = calculateLetterPrice(height, charCount, 'frontLit', state.prices);
            price = result.price;
            description = `${name || 'Letters'} - ${typeInfo?.name || 'Acrylic Front Lit'} (${height}cm x ${charCount} letters) - RECOMMENDED`;
        } else {
            letterType = '3d';
            const typeInfo = LETTER_TYPES.find(t => t.id === '3d');
            const result = calculateLetterPrice(height, charCount, '3d', state.prices);
            price = result.price;
            description = `${name || 'Letters'} - ${typeInfo?.name || '3D Non-LED'} (${height}cm x ${charCount} letters) - BUDGET`;
        }
    } else if (productType === 'logo') {
        const { name, length, width } = state.anchor.logo;
        if (length === 0 || width === 0) {
            showNotification('Please enter valid logo dimensions!', 'error');
            return;
        }

        if (optionType === 'premium') {
            const typeInfo = LETTER_TYPES.find(t => t.id === 'inox');
            const result = calculateLogoPrice(length, width, 'inox', state.prices);
            price = result.price;
            description = `${name || 'Logo'} - ${typeInfo?.name || 'Inox'} (${length}√ó${width}cm) - PREMIUM ANCHOR`;
        } else if (optionType === 'recommended') {
            const typeInfo = LETTER_TYPES.find(t => t.id === 'frontLit');
            const result = calculateLogoPrice(length, width, 'frontLit', state.prices);
            price = result.price;
            description = `${name || 'Logo'} - ${typeInfo?.name || 'Acrylic Front Lit'} (${length}√ó${width}cm) - RECOMMENDED`;
        } else {
            const typeInfo = LETTER_TYPES.find(t => t.id === '3d');
            const result = calculateLogoPrice(length, width, '3d', state.prices);
            price = result.price;
            description = `${name || 'Logo'} - ${typeInfo?.name || '3D Non-LED'} (${length}√ó${width}cm) - BUDGET`;
        }
    } else if (productType === 'panel') {
        const { name, length, width } = state.anchor.panel;
        if (length === 0 || width === 0) {
            showNotification('Please enter valid panel dimensions!', 'error');
            return;
        }

        const result = calculatePanelPrice(length, width, state.prices);
        if (optionType === 'premium') {
            price = result.price * 2;
            description = `${name || 'Alu Panel'} Premium (${length}√ó${width}cm) - ANCHOR PRICE`;
        } else if (optionType === 'recommended') {
            price = result.price;
            description = `${name || 'Alu Panel'} (${length}√ó${width}cm) - RECOMMENDED`;
        } else {
            price = result.price * 0.7;
            description = `${name || 'Alu Panel'} Budget (${length}√ó${width}cm) - BUDGET`;
        }
    }

    if (price > 0) {
        state.quotationItems.push({ description, price });
        renderQuotationItems();

        // Switch to quotation tab
        document.querySelector('[data-tab="quotation"]').click();

        const optionName = optionType === 'premium' ? 'Premium (Inox)' : optionType === 'recommended' ? 'Recommended (Acrylic)' : 'Budget (3D)';
        showNotification(`${optionName} option added to quotation!`, 'success');
    }
}

function addAllAnchorOptions() {
    const productType = state.anchor.productType;

    // Validate inputs based on product type
    if (productType === 'letter') {
        const { height, charCount } = state.anchor.letter;
        if (height < MIN_LETTER_HEIGHT || charCount === 0) {
            showNotification('Please enter valid letter dimensions (min 15cm height) and count!', 'error');
            return;
        }
    } else if (productType === 'logo') {
        const { length, width } = state.anchor.logo;
        if (length === 0 || width === 0) {
            showNotification('Please enter valid logo dimensions!', 'error');
            return;
        }
    } else if (productType === 'panel') {
        const { length, width } = state.anchor.panel;
        if (length === 0 || width === 0) {
            showNotification('Please enter valid panel dimensions!', 'error');
            return;
        }
    }

    // Add all 3 options
    addAnchorOption('premium');
    addAnchorOption('recommended');
    addAnchorOption('budget');

    showNotification('All 3 options added to quotation!', 'success');
}

function clearAnchor() {
    state.anchor = {
        productType: 'letter',
        letter: { name: '', height: 0, heightInches: 0, charCount: 0 },
        logo: { name: '', length: 0, width: 0, lengthInches: 0, widthInches: 0 },
        panel: { name: '', length: 0, width: 0, lengthInches: 0, widthInches: 0 }
    };

    // Clear letter inputs
    document.getElementById('anchorLetterName').value = '';
    document.getElementById('anchorLetterHeightInches').value = '';
    document.getElementById('anchorLetterHeight').value = '';
    document.getElementById('anchorLetterCount').value = '';

    // Clear logo inputs
    document.getElementById('anchorLogoName').value = '';
    document.getElementById('anchorLogoLengthInches').value = '';
    document.getElementById('anchorLogoLength').value = '';
    document.getElementById('anchorLogoWidthInches').value = '';
    document.getElementById('anchorLogoWidth').value = '';

    // Clear panel inputs
    document.getElementById('anchorPanelName').value = '';
    document.getElementById('anchorPanelLengthInches').value = '';
    document.getElementById('anchorPanelLength').value = '';
    document.getElementById('anchorPanelWidthInches').value = '';
    document.getElementById('anchorPanelWidth').value = '';

    // Reset product type to letter
    document.getElementById('anchorProductType').value = 'letter';
    showAnchorInputs('letter');

    // Update display
    updateAnchorCalculation();
}

// ==================== Start ====================
document.addEventListener('DOMContentLoaded', init);
